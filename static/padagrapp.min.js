/*!  12-04-2018 */
define(["jquery","underscore","backbone","mousetrap","semantic","cello","gviz","materials","moment","polyfill","numeric","pdgconst"],function(a,b,c,d,e,f,g,h,i,j,l,m){function n(a,c,d){d&&d.length?d+=" ":d="",b.each(c,function(c){if(b.isString(c))E.push("\n"+c);else{var e=d+c[0];o(e,c[1],c[2],a)}})}function o(a,b,c,e){e=void 0===e?document:e,d().bind(a,c),E.push("'"+a+"' : "+b)}function p(a,b,d){var e=["# Graph edition",["e","edits selected node",function(){var a=b.vs.by_flag("selected");1==a.length&&c.trigger("edit:node",a[0])}]];n(a,e,d)}function q(a,b,d){var e=[["enter","Expands node relations",function(){var a=b.vs.by_flag("selected");if(1==a.length){var d={graph:b.id,expand:[a[0].id],weights:[]};c.trigger("engine:expand_prox",d)}}],["shift+enter","Explore",function(){var a=b.vs.by_flag("selected");if(1==a.length){var d={graph:b.id,query:a[0].id};c.trigger("engine:explore",d)}}],["backspace","Removes node from view",function(){var a=b.vs.by_flag("selected");1==a.length&&c.trigger(m.remove_node,a[0])}]];n(a,e,d)}function r(a,b){n(a.$el,F(a),b)}function s(){o("h","Displays help",function(){var a=E.join("\n");console.log(a)})}function t(b){b in H==0&&(b="default"),a("#padagraph-top .menu").removeClass("inverted"),a("#padagraph-top .menu .input").removeClass("inverted"),a("#padagraph-right .fitted.pointing.menu").removeClass("inverted");var c=H[b];a("#padagraph-top").css("background",c.top),a("#padagraph-top .menu .menu").css("background",c.top_menu),a("#padagraph-right").css("background",c.right),a("#padagraph-viz").css("background",c.viz),a("padagraph-gviz")[0].gviz.set_clear_color(c.viz),a("padagraph-controls .menu").css("background",c.controls),c.top_inverted&&(a("#padagraph-top .menu").addClass("inverted"),a("#padagraph-top .menu .input").addClass("inverted"),a("#padagraph-top .menu .menu").addClass("inverted")),c.right_inverted&&a("#padagraph-right .fitted.pointing.menu").addClass("inverted"),I()}function u(b){b?(a("#padagraph-left").removeClass("twelve wide column").addClass("sixteen wide column"),a("#padagraph-right").hide()):(a("#padagraph-left").removeClass("sixteen wide column").addClass("twelve wide column"),a("#padagraph-right").show()),I()}function v(){a("#padagraph-right .item").tab()}function w(a){return a.reduce(function(a,b){return a>b?a:b})}function x(a){return a.reduce(function(a,b){return a<b?a:b})}function y(b){b.id&&a("#img"+b.id).remove()}function z(b){if(b.id&&b.properties.get("image")){var c=b.properties.get("image");"svg"==c.substring(c.length-3)?a.ajax({url:c,dataType:"text",success:function(d){var e=new Image;e.onload=function(){var d=document.getElementById("gviz_imgs_cache_canvas");d.width=400,d.height=400,d.getContext("2d").drawImage(e,0,0,400,400),c=d.toDataURL("image/png"),a("#gviz_model_imgs").append("<img id='img"+b.id+"' src='"+c+"'/>")},e.src="data:image/svg+xml;charset=utf-8,"+d}}):a("#gviz_model_imgs").append("<img id='img"+b.id+"' src='"+c+"'/>")}}function A(a){a.id&&a.properties&&a.properties.changed&&a.properties.changed.image&&(y(a),z(a))}function B(a,b){var c=a.vs;if(c.length&&!(!b|!("results"in b)|!("layout"in b.results))){var d=b.results.layout.coords,e=[],f=[],g={},h=0;for(var i in d){var j=d[i];j.push(0),f.push(j.slice(0,3)),c.get(i).get("coords")?e.push(c.get(i).get("coords").slice(0,3)):e.push(j.slice(0,3)),g[i]=h,h++}Q_new=G.rotate_graph(e,f);for(var i in d){var k=c.get(i);k.set("coords",Q_new[g[i]])}var l=c.map(function(a){return a.degree()}),m=w(l),n=x(l);c.each(function(a){var b=a.degree();a.set("_size",m>n?(b-n)/(m-n):1)})}}var C=!0;f.DEBUG=C,C||(console.log=function(){});var D={};D.User=c.Model.extend({defaults:{username:"",logged:!1,login_url:"../account/login",logout_url:"../account/logout"},login:function(b){var d=this;a.ajax({url:this.get("login_url"),type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){console.log("success",a),d.set(a),a.logged&&""!=a.username&&(c.trigger("user:logged_in",d.attributes),console.log("triggered",d.attributes))},error:function(){d.trigger("user:loginError")}})},logout:function(){var b=this;a.ajax({url:this.get("logout_url"),type:"POST",data:JSON.stringify({}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){b.set(a),c.trigger("user:logged_out",b.attributes),console.log("triggered","user:logged_out",b.attributes)},error:function(){b.trigger("user:logoutError")}})}}),D.Cluster=f.Cluster.extend({initialize:function(a,b){var c=this;D.Cluster.__super__.initialize.apply(this,arguments),this.on("change:color",function(){c.members.vs.each(function(a){a.set("cl_color",c.color)})})},_unselect:function(){this.members.vs.each(function(a){a.remove_flag("cluster")});var a=this.collection.without(this);b(a).each(function(a){a.members.vs.each(function(a){a.remove_flag("cluster-faded"),b.each(a.incident(),function(a){a.remove_flag("es-cluster-faded")})})})}}),D.Vertex=f.Vertex.extend({classname:"Models.Vertex",defaults:{uuid:null,nodetype:null,properties:new c.Model,cl_color:[0,0,0],color:[0,0,0]},url:function(){return this.graph.url()+"/node"+(this.id?"/"+this.id:"")},star:function(){this.set_starred(!0)},unstar:function(){this.set_starred(!1)},set_starred:function(b){var c=this.url()+(b?"/star":"/unstar");a.ajax({url:c,type:"POST",data:JSON.stringify({start:0}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){},error:function(){}})},format_label:function(a){var b=".form",c=this.label;return a&&(c=c.substring(0,a)),[{form:c,css:b}]},to_str:function(){return this.label},validate:function(a,b){var c=[];if(a.nodetype||c.push({field:"nodetype",header:"Nodetype",message:"a nodetype is required"}),Object.keys(a.properties.attributes).length||c.push({field:"properties",header:"Properties",message:"a node should have a property"}),c.length)return c},parse:function(a,b){return a.properties&&(a.properties=new c.Model(a.properties,{parse:!0})),a},get_properties:function(){var a=this,b={};return this.nodetype.get("properties").each(function(c){var d=c.get("name");"uuid"!=d&&(b[d]=a.properties.get(d))}),b},fetch_neighbors:function(b,c){var d=this,e=this.url();return this._neighbors?void c(this._neighbors):void a.ajax({url:e+"/neighbors",type:"POST",data:JSON.stringify({start:0,mode:this.mode}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){var b={};if(a.neighbors){for(var e in a.neighbors){var f=a.neighbors[e],g=f[0].uuid;b[g]=f}var h=[];for(var i in b)h.push(b[i]);d._neighbors=h}c(d._neighbors)}})},toCard:function(){return{uuid:this.id,label:this.label,nodetype:this.nodetype.get("name")}},toJSON:function(a){return{uuid:this.get("uuid"),nodetype:this.get("nodetype"),properties:this.get_properties()}}},{active_flags:["intersected","faded","selected"]}),D.EdgeType=f.EdgeType.extend({parse_label:function(){var a=this.label,b=(a.substring(a.indexOf("/")+1),{});return b.label=a,b.family=a.indexOf("/")>=0?a.substring(0,a.indexOf("/")):"",b.name=a.indexOf("/")>0?a.substring(a.indexOf("/")):a,b.subscript="",b}}),D.Edge=f.Edge.extend({url:function(){return this.graph.url()+"/edge"+(this.id?"/"+this.id:"")},get_properties:function(){var a=this,b={};return this.edgetype.get("properties").each(function(c){var d=c.get("name");"uuid"!=d&&(b[d]=a.properties.get(d))}),b},validate:function(a,b){var c=[];if(a.source||c.push({field:"source",header:"Source",message:"a source is required"}),a.target||c.push({field:"target",header:"Target",message:"a target is required"}),a.edgetype||c.push({field:"edgetype",header:"Edgetype",message:"a edgetype is required"}),c.length)return c},parse:function(a,b){return a.properties&&(a.properties=new c.Model(a.properties,{parse:!0})),a},toJSON:function(a){return{uuid:this.id,edgetype:this.edgetype.id,source:this.get("source"),target:this.get("target"),properties:this.get_properties()}}},{active_flags:["intersected","faded","selected"]}),D.UuidEdgeListQuery=c.Model.extend({defaults:{graph:null},export_for_engine:function(){var a=b.map(this.get("graph").es.models,function(a){return a.get("uuid")});return{format:"uuid_edgelist",graph:this.get("graph").get("gid"),edgelist:a}}}),D.IndexEdgeListQuery=c.Model.extend({defaults:{graph:null},export_for_engine:function(){var a=this.get("graph"),c=b.chain(a.vs.models).filter(function(a){return 0==a.has_flag("disabled")}).map(function(a){return a.get("uuid")}).value(),d=b.chain(c).map(function(a,b){return[a,b]}).object().value(),e=b.chain(a.es.models).filter(function(a){return 0==a.has_flag("disabled")}).map(function(a,b){return[d[a.source.id],d[a.target.id]]}).value(),f=b.chain(a.es.models).filter(function(a){return 0==a.has_flag("disabled")}).map(function(a,b){var c=a.properties.get("weight",1);return c?parseFloat(c):1}).value();return{format:"index_edgelist",graph:this.get("graph").get("gid"),nodelist:c,edgelist:e,weights:f,directed:!0}}}),D.ExpandNodesQuery=c.Model.extend({defaults:{graph:null,nodes:[],expand:[],weights:[]},export_for_engine:function(){var a=b.map(this.get("graph").vs.models,function(a){return a.get("uuid")});return{graph:this.get("graph").get("gid"),nodes:a,expand:this.get("expand"),weights:this.get("weights")}}}),D.ClustersLabelsQuery=c.Model.extend({defaults:{graph:null,clustering:[]},export_for_engine:function(){var a=this.get("clustering"),b=a.clusters.models,c=b.map(function(a){var b=a.members.vs.models.map(function(a){return a.id});return b});return{graph:this.get("graph").get("gid"),clusters:c}}}),D.AdditiveNodesQuery=c.Model.extend({defaults:{graph:null,uuids:[]},export_for_engine:function(){var a=b.map(this.get("graph").vs.models,function(a){return a.get("uuid")});return{graph:this.get("graph").get("gid"),nodes:a,add:this.get("uuids")}}}),D.QueryUnit=c.Model.extend({defaults:{query:"",valid:!1},initialize:function(a,b){this.on("change",this.validate)},set_from_str:function(a){this.set("query",a)},to_string:function(){return this.get("query")},toJSON:function(){return{query:this.get("query")}},validate:function(){}}),QueryUnits=c.Collection.extend({model:D.QueryUnit,graph:"",reset_from_models:function(a){b.isArray(a)===!1&&(a=[a]);var c=[],d=this.model;b.each(a,function(a){attrs=b.pick(a,"query");var e=new d(attrs);c.push(e)}),this.reset(c)},reset_from_str:function(a){console.log("query : "+a);var c=this.model,d=[],e=a.split(",");b.each(e,function(a){var b=new c;b.set_from_str(a),d.push(b)}),this.reset(d)},reset_random:function(){var b=this,c=this.model;a.ajax({url:this.random_url,dataType:"json",success:function(a){var d=new c(a);b.reset_from_models([d])}})},to_string:function(){return this.models.map(function(a){return a.to_string()}).join("; ")},validate:function(){return this.length>0},export_for_engine:function(){return{graph:this.graph,units:this.toJSON()}}});var E=[],F=function(a){return["* Labels ",["l","toggles node/edge label display",function(){a.show_text=!a.show_text,a.renderer.DISPLAY_EDGE_LABEL=!a.renderer.DISPLAY_EDGE_LABEL,a.request_animation()}],["+","increase vertex size",function(){a.increase_vertex_size()}],["-","decrease vertex size",function(){a.decrease_vertex_size()}],[",","increase font label size",function(){a.user_font_size=Math.min(25,a.user_font_size+1),a.request_animation()}],[";","decrease font label size",function(){a.user_font_size=Math.max(-5,a.user_font_size-1),a.request_animation()}],"* Nodes/edges ",["n","toggle node display",function(){a.show_nodes=!a.show_nodes,a.request_animation()}],["e","toggle edge display",function(){a.show_edges=!a.show_edges,a.request_animation()}],["i","toggle node image display",function(){a.show_images=!a.show_images,a.request_animation(),console.log("toggle image display",a.show_images)}],"* Rendering ",["r","toggles autorotate",function(){a.controls.AUTO_ROTATE=!a.controls.AUTO_ROTATE,a.request_animation()}],["d","increases autorotate speed",function(){a.controls.autoRotateSpeed=1.5*a.controls.autoRotateSpeed}],["s","decreases autorotate speed",function(){a.controls.autoRotateSpeed=a.controls.autoRotateSpeed/1.5}],["e","toggle end arrow display",function(){a.renderer.DISPLAY_EDGE=!a.renderer.DISPLAY_EDGE,a.request_animation()}],["a","toggle init arrows display",function(){a.DISPLAY_ARROW_END=!a.DISPLAY_ARROW_END,a.DISPLAY_ARROW_INIT=!a.DISPLAY_ARROW_INIT,a.request_animation()}],["f","toggle fog display",function(){a.ENABLE_FOG=!a.ENABLE_FOG,a.request_animation()}],["w","toggle coords transition",function(){a.changeCoordSpeed=a.changeCoordSpeed>10?10:500}]]},G={rotate_graph:function(a,b){try{var c=numeric.dot(numeric.transpose(a),b),d=numeric.svd(c),e=numeric.transpose(d.U),f=d.V,g=numeric.det(numeric.dot(f,e)),h=(0!=g)*(1-2*(g<0));h=1;var i=[[1,0,0],[0,1,0],[0,0,h]],j=numeric.dot(numeric.dot(f,i),e),k=numeric.dot(b,j);numeric.norm2(numeric.sub(a,b)),numeric.norm2(numeric.sub(a,k));return k}catch(a){return console.log("rotate_graph",a),b}}},H={default:{top:"#FFF",top_menu:"#FFF",right:"#FFF",viz:"#EEE",controls:"#EEE",top_inverted:!1,right_inverted:!1},grietdore:{top:"#333",top_menu:"#FFF",right:"#E7E7E7",viz:"#999900",controls:"#7E7E00",top_inverted:!0,right_inverted:!1},camouflage:{top:"rgb(93, 112, 92)",top_menu:"#FFF",right:"rgb(93, 112, 92)",viz:"rgb(122, 143, 121)",controls:"rgb(93, 112, 92)",top_inverted:!0,right_inverted:!0}},I=function(){var b=(a(this),a(window).height());a("#padagraph-viz").height(b-52),a("#padagraph-right").height(b-6),a("padagraph-gviz")[0].gviz.resize_rendering()};a(window).on("resize",I);var J={};return J.Models=D,J.Base=c.View.extend({DEBUG:!1,initialize:function(a){this.DEBUG=a.debug||this.DEBUG,this.root_url=a.root_url||"/";var c=function(a){return a&&b.isString(a)?{url:a}:"url"in a?a:null};this.routes={};for(k in a.routes)this.routes[k]=c(a.routes[k]);this.complete_url=this.routes.complete_url,this.login_url=a.login_url,this.logout_url=a.logout_url,this.random_url=a.random_url,this.fullscreen=!1,this.$el=void 0===a.$el?document:a.$el,this.ALLOW_AUTO_COMPUTE=!0,this._auto_compute_delay=!1,this.Models=D,this.models=b.clone({}),this.engines=b.clone({})},create_user_model:function(){var a=this,b=new D.User;b.listenTo(c,"user:logout",b.logout),b.listenTo(c,"user:login",b.login),a.models.user=b},create_query_model:function(){var a=this;a.models.query=new QueryUnits([],{})},create_graph_model:function(a){var d=this;a=b.extend({vertex_model:D.Vertex,edge_model:D.Edge,edgetype_model:D.EdgeType},a?a:{});var e=new f.Graph(a);d.models.graph=e,d.listenTo(e.es,"remove",b.bind(d.auto_compute,d)),d.listenTo(e.vs,"add",d.auto_compute,d),d.listenTo(e.vs,"add",z),d.listenTo(e.vs,"change",A),d.listenTo(e.vs,"remove",function(a){y(a),e.vs.set_selected([])}),d.listenTo(c,m.unselect_nodes,function(){e.vs.set_selected([])}),d.listenTo(c,m.unselect_edges,function(){e.es.set_selected([])}),d.listenTo(c,m.select_node,function(a){a.id&&e.vs.get(a.id)&&(c.trigger(m.unselect_nodes),c.trigger(m.unselect_edges),e.vs.set_selected(a))}),d.listenTo(c,m.select_edge,function(a,b){c.trigger(m.unselect_nodes),c.trigger(m.unselect_edges)}),d.listenTo(c,m.remove_all,function(){d.set_auto_compute(!1),e.vs.set([]),e.es.set([]),d.set_auto_compute(!0)}),d.listenTo(c,m.remove_node,function(a){d.set_auto_compute(!1),a&&(e.vs.set_selected([]),e.vs.remove(a)),d.set_auto_compute(!0),d.trigger("engine:auto_compute",d.models.graph)}),d.listenTo(c,m.remove_edge,function(a){d.set_auto_compute(!1),a&&(e.es.set_selected([]),e.es.remove(a)),d.set_auto_compute(!0),d.trigger("engine:auto_compute",d.models.graph)}),this.listenTo(c,"request-graph-clear",function(a){c.trigger(m.unselect_nodes),c.trigger(m.unselect_edges),d.set_auto_compute(!1),e.vs.set([]),d.set_auto_compute(!0)})},create_clustering_model:function(){var a=this;a.models.clustering=new f.Clustering({ClusterModel:D.Cluster,color_saturation:71,color_value:80})},create_engines:function(){var a=this,d=a.routes,e=function(b){var d=new f.Engine(b);return a.listenTo(d,"play:loading",function(){c.trigger("play:loading",d)}),a.listenTo(d,"play:error",function(){c.trigger("play:complete",d)}),a.listenTo(d,"play:success",function(){c.trigger("play:complete",d)}),d};if(d.explore){var g=e({url:d.explore.url});g.register_input("request",a.models.query),a.listenTo(c,"engine:explore",function(b){a.models.query.reset_from_models(b),g.play()}),a.listenTo(g,"play:success",a.explore_reset),a.engines.explore=g}if(d.starred){var h=e({url:d.starred.url});h.register_input("request",a.models.query),a.listenTo(c,"engine:starred",function(b){a.models.query.reset_from_models(b),h.play()}),a.listenTo(h,"play:success",a.explore_reset),a.engines.starred=h}if(d.additive_nodes){var i=new D.AdditiveNodesQuery({graph:a.models.graph});a.engines.additive_nodes=e({url:d.additive_nodes.url}),a.engines.additive_nodes.register_input("request",i),a.listenTo(c,"engine:additive_nodes",a.additive_nodes),a.listenTo(a.engines.additive_nodes,"play:success",a.merge_graph)}if(d.expand_px){var j=new D.ExpandNodesQuery({graph:a.models.graph});a.engines.expand_prox=e({url:d.expand_px.url}),a.engines.expand_prox.register_input("request",j),a.listenTo(c,"engine:expand_prox",function(b){console.log("engine:expand_prox",b),j.set("expand",b.expand),j.set("weights",b.weights),a.engines.expand_prox.play()}),a.listenTo(a.engines.expand_prox,"play:success",a.expand_graph)}if(d.layout){var k=e({url:d.layout.url});k.register_input("request",new D.IndexEdgeListQuery({graph:a.models.graph})),a.on("engine:layout",function(a){if(k.blocks.length){console.log("engine:layout",a);var b=k.blocks.at(0).components;b.each(function(a){a.set("selected",!1)});var c=b.get(a);c||(c=b.at(0)),c.set("selected",!0),k.play()}});var l=(a.models.graph,function(a,b,d){B(b,d),a._additive_nodes_delayed=!1,c.trigger("engine:request_animation")});a.listenTo(k,"play:success",b.partial(l,a,a.models.graph)),a.engines.layout=k}if(d.clustering){var m=e({url:d.clustering.url});m.register_input("request",new D.IndexEdgeListQuery({graph:a.models.graph})),a.on("engine:clustering",function(a){console.log("engine:clustering",a);var b=m.blocks;if(b.length){var c=b.at(0).components;c.each(function(a){a.set("selected",!1)});var d=c.get(a);d||(d=c.at(0)),d.set("selected",!0),m.play()}}),a.listenTo(m,"play:success",a.apply_clustering),a.engines.clustering=m}for(var n in d)if(!a.engines[n]){var o=e({url:d[n].url});a.engines[n]=o}a.listenTo(c,"play:error",a.engine_play_error),a.on("engine:auto_compute",a.auto_compute)},fetch_engines:function(a){var c=this,d={complete:a,count:b.size(c.engines)},e=function(a){if(d.count-=1,console.log(" engine_fetched ",d.count),0==d.count)if(d.complete)d.complete(c);else{var b=new Event("app_engines_fetched",{bubbles:!0,cancelable:!1});document.dispatchEvent(b)}};c.engines.layout&&c.engines.layout.fetch({success:function(a,d,f,g){if(b.size(d.blocks)){var h=d.blocks.at(0),i=h.components.models,j=[],k=["# Layouts"],l=0;for(var m in i){l++;var o=""+l,p=i[m].id+"|";p=p.substring(0,p.indexOf("|"));var q=""+i[m].id,r=function(a){return function(){c.trigger("engine:layout",a)}};k.push([o,p,r(q)]),j.push({name:p,value:q,model:i[m]})}n(this.$el,k,"!"),c.setLayouts(j),e()}}}),c.engines.clustering&&c.engines.clustering.fetch({success:function(a,d,f,g){if(b.size(d.blocks)){var h=d.blocks.at(0),i=h.components.models,j=[],k=["# Community detection"],l=0;for(var m in i){l++;var o=""+l,p=i[m].id+"|";p=p.substring(0,p.indexOf("|"));var q=i[m].id,r=function(a){return function(){c.trigger("engine:clustering",a)}};k.push([o,p,r(q)]),j.push({name:p,value:q,model:i[m]})}n(this.$el,k,":"),c.setClusterings(j),e()}}});for(var f in c.engines)console.log(" FETCH ENGINES "+f),"clustering"!=f&&"layout"!=f&&c.engines[f].fetch({success:e})},auto_compute:function(){if(this.ALLOW_AUTO_COMPUTE&&!this._auto_compute_delay){var a=this.models.graph;a&&a.vs&&a.vs.length&&(this.engines.clustering&&this.engines.clustering.play(),this.engines.layout&&this.engines.layout.play())}},noop:function(){},additive_nodes:function(a,c){if(this._additive_nodes_uuids=b.union(this._additive_nodes_uuids,a),!this._additive_nodes_delay){this._additive_nodes_delayed=!0;var d=this.engines.additive_nodes;console.log("engine:additive_nodes",this._additive_nodes_uuids,c),d.input_models.request.set("uuids",this._additive_nodes_uuids),d.play(c),this._additive_nodes_uuids=[]}},explore_reset:function(a){c.trigger(m.unselect_nodes),c.trigger(m.unselect_edges);var b=this;b.response=a,console.log("explore_reset",a.results),b.set_auto_compute(!1),a.results.graph&&(b.models.graph.reset(a.results.graph),b.models.graph.set("gid",a.results.graph.properties.name),b.models.graph.vs.each(function(a){a.add_flag("form")})),b.set_auto_compute(!0),b.auto_compute()},expand_graph:function(a){if(console.log("expand_graph",a.results),!(!a|!("results"in a))){var d=this.models.graph,e=[],f=b.pairs(a.results.scores);f.sort(function(a,b){return a[1]<b[1]?1:-1});for(var g in f){var h=f[g][0],i=f[g][1];if(null==d.vs.get(h)){if(e.length>=10&&i<1)break;console.log("expand_graph adding vertex : "+h,i),e.push(h)}}e.length&&c.trigger("engine:additive_nodes",e)}},clusters_labels:function(a,b){this.models.clustering.set_labels(a.results,b)},merge_graph:function(a,b){!a|!("results"in a)|!("graph"in a.results)||(this.set_auto_compute(!1),b||(b={}),b&&b.reset?this.models.graph.reset(a.results.graph):this.models.graph.merge(a.results.graph),this.models.graph.vs.each(function(a){a.add_flag("form")}),b.callback&&b.callback(),this.set_auto_compute(!0),this.auto_compute())},apply_clustering:function(a){if(!a|!("results"in a)|!("clusters"in a.results))return void c.trigger("engine:error",{message:"No response or no results in response",response:a});this.models.clustering.reset(a.results.clusters,{members:{vs:{source:this.models.graph.vs,id_field:"vids"}}}),this.models.clustering.clusters.each(function(a){a.listenTo(c,"unselect_clusters",function(){a.remove_flag("selected")})});for(var d in this.models.clustering.clusters.models){var e=this.models.clustering.clusters.at(d),f=e.members.vs.models,g="000"+d,h=g.substring(g.length-3)+"/"+(e.misc?"0":"1");b.each(f,function(a){a.set("_sort_by_cluster",h+"/"+a.label)})}c.trigger("engine:request_animation")},set_auto_compute:function(a){this.ALLOW_AUTO_COMPUTE=a},search_loading:function(a,b){},engine_play_error:function(c,d){var e=this;if(console.log("play:error","response",c),a("#loading-indicator").hide(0),e.DEBUG){e.response=c,e.xhr=d;var f;b.isEmpty(c)?(f=a(d.responseText),a("body").css("margin","0")):f=c.meta.errors.join("<br />"),a("body").after(f)}},set_viz:function(a){var d=this,e=d.models.graph;this.listenTo(c,m.select_node,function(c){if(d.AUTO_FOCUS){var e=b.pick(a.wnidx[c.id].position,"x","y","z");a.setFocus(e)}a.request_animation()}),this.listenTo(c,m.select_edge,function(b,c){b&&e.es.set_selected(b),a.setFocus()}),this.listenTo(e,"change:gid",function(){a.collapse()}),s(),r(a,""),q(this.$el,this.models.graph,""),p(this.$el,this.models.graph,""),a.animate()},install_listeners:function(){}}),J.Iframe=J.Base.extend({initialize:function(a,b){J.Iframe.__super__.initialize.apply(this,arguments)},setClusterings:function(a){this.clusterings=a},setLayouts:function(a){this.layouts=a}}),J.Simple=J.Base.extend({initialize:function(a,b){J.Simple.__super__.initialize.apply(this,arguments)},setClusterings:function(b){var c=a("padagraph-app-menu")[0],d=a("padagraph-controls")[0];c.clusterings=b,d.clusterings=b,this.clusterings=b},setLayouts:function(b){var c=a("padagraph-app-menu")[0],d=a("padagraph-controls")[0];c.layouts=b,d.layouts=b,this.layouts=b},create_models:function(){this.create_graph_model(),this.create_clustering_model(),this.create_query_model(),this.create_user_model()},start:function(){var b=this,d=b.models.graph;b.listenTo(d,"change:gid",function(){a("padagraph-graph-button")[0].graphname=d.id});var e=a("padagraph-app-menu")[0];e.themes=Object.keys(H),e.graph=d,e.app=b;var g=a("padagraph-controls")[0];g.themes=Object.keys(H),g.app=b,g.gviz=l,g.graph=d,g.setupUI();var h=a("padagraph-create")[0];h.graph=d,h.nodetype_model=d.nodetype_model,h.edgetype_model=d.edgetype_model,h.vertex_model=d.vertex_model,h.edge_model=d.edge_model;var i=a("padagraph-edits")[0];i.graph=d;var j=a("padagraph-messages")[0];j.graph=d,a("padagraph-node-search")[0].graph=d,a("padagraph-notifications")[0].setGraphModel(d),a("#newNodeType").click(function(){c.trigger("edit:nodetype",!1)}),v(),this.setFullscreen=function(a){this.fullscreen=a,u(a)},this.setTheme=t;var k=a("padagraph-gviz")[0],l=k.gviz;b.set_viz(l),this.gviz=k,window._app=this,window.Cello=f,window.Models=D,console.warn=function(){}}}),J});